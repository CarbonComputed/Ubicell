
{%from bson.objectid import ObjectId%}
<html>
<head>
	<link rel="stylesheet" href="/static/styles/base2.css" type="text/css" />
	<link rel="stylesheet" href="/static/styles/font-awesome.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="/static/styles/dropdown.css?1.3" />

	<link rel="stylesheet" href="/static/styles/switch.css" type="text/css" />
	<script src="/static/jquery-1.9.1.min.js"></script>

	<script src="/static/js/dropdown.js"></script>
	<script type="text/javascript" src="/static/js/modernizr.custom.79639.js"></script> 

	{%block scripts%}

	{%end%}

</head>
<body>
	<div id="background-grad"></div>

	<div class="clear"></div>
	{%block nav%}
	<div id="top-nav">

		<div id="left-top-nav">
			<div id="logo">
				<a href="/" class="fill-div"></a>
				<h1>uPlace</h1>
				<img src="/static/images/logo2.svg" href="/" height="60px" width="100px">
			</div>
		</div>
		<div id="center-top-nav">

			<div id="search-area">
				<form action="#" onsubmit="searchFriends();return false;">
				<input class="search_box" type="text" name="search" >
				<a class="btn" href="#" onclick="searchFriends()"><i class="icon-search"></i></a>
				</form>
			</div>
		</div>
		<div id="right-top-nav">

			<span>
				<a href="/">Feed</a>
				<a href="/user/{{escape(current_user['UserName'])}}">Profile</a>
				<!-- <a class = "btn" id="setting" href="#"><i class="icon-cogs"></i></a> -->
				<div id="dd" class="wrapper-dropdown-2" tabindex="1"><i id="tab" class="icon-cogs icon-small"></i>
					<ul class="dropdown">
						<li><a href="#"><i class="icon-envelope icon-small"></i>Send File</a></li>
						<li><a href="#"><i class="icon-edit icon-small"></i>Edit Profile</a></li>
						<li><a href="/auth/logout"><i class="icon-signout icon-small"></i>Logout</a></li>
					</ul>
				</div>
			</div>
		</span>
	</div>
	</div>
	{% end %}
	<div class="clear"></div>
	{%block container%}
	<div id="container">
		<div id="left-side-bar">

		</div>
		<div id="Main-Content">
			<h2 style="float:left;color:gray;margin: 5px 5px 5px 5px;">Feed</h2>
			<div class="onoffswitch">
				<input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="myonoffswitch" checked>
				<label class="onoffswitch-label" for="myonoffswitch">
					<div class="onoffswitch-inner"></div>
					<div class="onoffswitch-switch"></div>
				</label>
			</div>
			<div class="clear"></div>

			<div id="Status">
				<form action="#" onsubmit="post();return false;">
					<textarea id="status_text" class="status_box" type="text" name="status" placeholder="Whatsup {{current_user['FirstName'].capitalize()}}?"></textarea>
					<input class="status_button" type="submit" value="Post!" >
				</form>
			</div>
			<div id="Status-Feed">
				{%for post in feed%}
<!--  -->			{%if post['Wall']['FriendId'] != post['Wall']['UserId'] %}
						{%from actions import *%}
						{%set user = user_actions.get_simple_data(post['Wall']['FriendId'])%}
					<div id="Status-sec" data-postid={{post['Wall']['id']}} data-ownerid={{post['_id']}}>
					<a href="/user/{{user['UserName']}}"><img src="/images?picid={{str(user['ProfileImg'])}}" href="/user/{{user['UserName']}}" height="52" width="52"></a>
					<div id="status-post">
						<p><a class="Name" href="/user/{{user['UserName']}}">{{user['FirstName'].capitalize()}} {{user['LastName'].capitalize()}}<i class="icon-caret-right" style="color:black;padding-bottom:5px;"></i><a class="Name" href="/user/{{post['UserName']}}">{{post['FirstName'].capitalize()}} {{post['LastName'].capitalize()}}</a></p>
						<p class="post">{{post['Wall']['Message']}}</p>
						<a href="#" onclick="loadReplies();return false;"style="float:left;background:white;font-size:11px;padding-top:10px;color:black;">Load Comments</a>
						<a href="#" style="float:left;background:white;font-size:11px;padding-top:10px;color:black;padding-left:10px;">Reply</a>						

					</div>
					<div id="Votes">
						{%set color = 'white'%}
						{% if ObjectId(current_user['_id']['$oid']) in post['Wall']['Upvoters'] %}
							{%set color = 'orange'%}
						{%end%}
						<a style="color:{{color}};" href="#" onclick="vote(this,'up')" ><i style="color:{{color}};" class="icon-arrow-up"></i></a>

						<p>{{post['Wall']['Upvotes']-post['Wall']['Downvotes']}}</p>
						{%set color = 'white'%}
						{% if ObjectId(current_user['_id']['$oid']) in post['Wall']['Downvoters'] %}
							{%set color = 'orange'%}
						{%end%}
						<a href="#" onclick="vote(this,'down')"><i style="color:{{color}};" class="icon-arrow-down"></i></a>
						<div class="clear"></div>

					</div>
					<div class="clear"></div>

				</div>
					{%else%}
						{%set user = userdata%}
					
				<div id="Status-sec" data-postid={{post['Wall']['id']}} data-ownerid={{post['_id']}}>
					<a href="/user/{{post['UserName']}}"><img src="/images?picid={{str(post['ProfileImg'])}}" href="/user/{{post['UserName']}}" height="52" width="52"></a>
					<div id="status-post">
						<a class="Name" href="/user/{{post['UserName']}}">{{post['FirstName'].capitalize()}} {{post['LastName'].capitalize()}}</a></br>
						<p class="post">{{post['Wall']['Message']}}</p>
						<a href="#" onclick="loadReplies();return false;" style="float:left;background:white;font-size:11px;padding-top:10px;color:black;">Load Comments</a>
						<a href="#" onclick="displayReply(this);"style="float:left;background:white;font-size:11px;padding-top:10px;color:black;padding-left:10px;">Reply</a>
					</div>
					<div id="Votes">
						{%set color = 'white'%}
						{% if ObjectId(current_user['_id']['$oid']) in post['Wall']['Upvoters'] %}
							{%set color = 'orange'%}
						{%end%}
						<a  href="#" onclick="vote(this,'up')" ><i style="color:{{color}};" class="icon-arrow-up"></i></a>
						<p>{{post['Wall']['Upvotes']-post['Wall']['Downvotes']}}</p>
						{%set color = 'white'%}
						{% if ObjectId(current_user['_id']['$oid']) in post['Wall']['Downvoters'] %}
							{%set color = 'orange'%}
						{%end%}
						<a href="#" onclick="vote(this,'down')"><i style="color:{{color}};" class="icon-arrow-down"></i></a>
						<div class="clear"></div>

					</div>
					<div class="clear"></div>
				{%block reply_sec%}
				<div id="reply-box" data-postid={{post['Wall']['id']}}  style="text-align:left;"> 
					<form>
						<textarea id="reply_text_id" class="reply_text"></textarea>
						<a id="rep_link" onclick="reply(this);return false;" href="#">Reply</a>
						<a onclick="hideReply(this)" href="#">Cancel</a>

					</form>
				</div>
				{%end%}
				</div>
				
				<div id="reply-sec">

				</div>
				{%end%}
				{%end%}


			</div>
		</div>
	{%end%}

	</div>
</body>


<script type="text/javascript">
	$(document).ready(function() {
 		 $('#reply-box').hide();
	});

	function loadReplies(){
		$('#reply-sec').load('/actions/get_replies?post_id=514b65d24074506c927d6db8&owner_id=5149cb8b8f24a067b266a305');
	}

	function searchFriends(){
		var query = $('.search_box').val();
		$('head').append('<link rel="stylesheet" type="text/css" href="/static/styles/search.css">');
		$('#Main-Content').load("/search?" + $.param({ query : query}) + " #Main-Content > *").hide().fadeIn(700);

	}

	function vote(ele,type){
		var postid = $(ele).closest('#Status-sec').data()['postid'];
		var ownerid = $(ele).closest('#Status-sec').data()['ownerid'];
		console.log(postid);
		var element = $(ele).closest('#Status-sec');
		var vote_type = "";
		if(type == 'up'){
			vote_type = "up";
		}
		else{
			vote_type = "down";
		}
		$.ajax({
			  type: "POST",
			  url: '/actions/friend_vote',
			  data: { 'vote_type' : vote_type,'post_owner' : ownerid,'post_id' : postid},
			  success: function(){ alert('success');
			  },
			  dataType: 'json'
			});
		$('#Status-Feed').load('/ #Status-Feed > *').hide().fadeIn(700);
	}
	function post(){
		{% from constants import * %}
		var message = $('#status_text').val();
		var posttype = parseInt({{PostType.WALL_POST}});
		console.log(posttype);
		$.ajax({
			  type: "POST",
			  url: '/actions/post',
			  data: { 'message' : message, 'posttype' : posttype},
			  success: function(){ alert('success');
			  },
			  dataType: 'json'
			});

		$('#Status-Feed').load('/ #Status-Feed > *').hide().fadeIn('slow');
		$('#status_text').val('');

	}

	function reply(post){
		var ele = $(post).closest('#Status-sec').data()['postid'];
		var postid = $(post).closest('#Status-sec').data()['postid'];
		var ownerid = $(post).closest('#Status-sec').data()['ownerid'];
		var message = 	$("#reply-box[data-postid='" + ele + "'] textarea").val();

		console.log(message);
		var replyid = postid;
		{% from constants import * %}
		var posttype = parseInt({{PostType.REPLY_POST}});

				$.ajax({
			  type: "POST",
			  url: '/actions/post',
			  data: { 'message' : message, 'posttype' : posttype, 'postid' : postid,'ownerid' : ownerid,'replyid':replyid},
			  success: function(){ alert('success');
			  },
			  dataType: 'json'
			});


	}

	function displayReply(post){
		var ele = $(post).closest('#Status-sec').data()['postid'];
		$("#reply-box[data-postid='" + ele + "']").show();
	}

	function hideReply(post){
		$(post).closest('#reply-box').hide();
	}
	function getPosts(){
		var feed=		$.ajax({
			  type: "GET",
			  url: '/actions/post',
			  data: { },
			  success: function(){ alert('success');
			  },
			  dataType: 'json'
			});
		console.log(feed);
	}

</script>
{%block funcs%}
{%end%}
</html>